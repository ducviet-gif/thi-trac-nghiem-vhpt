<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>H·ªá th·ªëng K76.A03 - Phi√™n b·∫£n v27</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary: #2c3e50; --secondary: #27ae60; --danger: #e74c3c; 
            --accent: #2980b9; --light: #f4f7f6; --shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; color: #1a1a1a; font-size: 18px; background-color: var(--light); }
        
        /* Trang ƒêƒÉng nh·∫≠p 3D chuy√™n nghi·ªáp */
        #auth-page { 
            height: 100vh; width: 100%; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1507842217343-583bb7270b66?auto=format&fit=crop&w=1920&q=80');
            background-size: cover; background-position: center; position: fixed; top: 0; left: 0; z-index: 9999;
        }
        .auth-box { background: rgba(255, 255, 255, 0.98); padding: 40px; border-radius: 25px; width: 450px; box-shadow: var(--shadow); text-align: center; border: 1px solid white; }
        .auth-box h1 { font-size: 26px; color: var(--primary); margin-bottom: 5px; }
        .auth-box h2 { font-size: 20px; color: var(--accent); margin-bottom: 25px; }
        
        .container { max-width: 1200px; margin: 20px auto; background: white; padding: 30px; border-radius: 25px; box-shadow: var(--shadow); }
        
        /* N√∫t b·∫•m 3D */
        nav { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        button { padding: 12px 20px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.1s; box-shadow: 0 5px #7f8c8d; position: relative; outline: none; }
        button:active { box-shadow: 0 0 #7f8c8d; transform: translateY(5px); }
        .btn-main { background: var(--primary); color: white; }
        .btn-sub { background: var(--accent); color: white; box-shadow: 0 5px #1a5276; }
        .btn-green { background: var(--secondary); color: white; box-shadow: 0 5px #196f3d; }
        .btn-orange { background: #d35400; color: white; box-shadow: 0 5px #a04000; }
        .btn-purple { background: #8e44ad; color: white; box-shadow: 0 5px #6c3483; }

        /* Quiz UI */
        .q-block { border: 1px solid #cfd8dc; padding: 25px; margin: 15px 0; border-radius: 15px; background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .q-block p { font-weight: bold; font-size: 22px; color: #0d47a1; margin-top: 0; line-height: 1.4; }
        .option-item { display: flex; align-items: center; margin: 10px 0; padding: 12px; border-radius: 12px; border: 1px solid #eee; cursor: pointer; }
        .option-item:hover { background: #f0f7ff; border-color: var(--accent); }
        input[type="radio"] { width: 32px; height: 32px; margin-right: 20px; flex-shrink: 0; cursor: pointer; }
        
        .correct-ans { background: #e8f5e9 !important; border-left: 10px solid #2e7d32 !important; }
        .wrong-ans { background: #ffebee !important; border-left: 10px solid #c62828 !important; }

        .result-header { background: #fff9c4; border: 4px solid #fbc02d; padding: 20px; margin-bottom: 20px; border-radius: 15px; text-align: center; display: none; }
        .table-area { max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #eceff1; padding: 15px; position: sticky; top: 0; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="auth-page">
    <div class="auth-box">
        <h1 id="auth-title">H·ªá th·ªëng √în thi Tr·∫Øc nghi·ªám</h1>
        <h2 id="auth-subtitle">M√¥n: VƒÉn ho√° Ph√°t tri·ªÉn - K76.A03</h2>
        
        <div id="login-section">
            <input type="text" id="user-name" style="width:100%; padding:15px; margin-bottom:15px; border-radius:10px; border:1px solid #ccc; font-size:18px; box-sizing: border-box;" placeholder="T√™n t√†i kho·∫£n">
            <input type="password" id="user-pass" style="width:100%; padding:15px; margin-bottom:20px; border-radius:10px; border:1px solid #ccc; font-size:18px; box-sizing: border-box;" placeholder="M·∫≠t kh·∫©u">
            
            <button class="btn-main" style="width:100%; font-size:18px;" onclick="handleLogin()">ƒêƒÇNG NH·∫¨P</button>
            <button class="btn-green" style="width:100%; margin-top:12px; font-size:18px;" onclick="handleGuest()">V√ÄO NHANH (GUEST)</button>
            <p style="margin-top:20px; font-size:16px;">Ch∆∞a c√≥ t√†i kho·∫£n? <a href="javascript:void(0)" onclick="showReg()">ƒêƒÉng k√Ω t·∫°i ƒë√¢y</a></p>
        </div>

        <div id="reg-section" class="hidden">
            <h3 style="color:var(--secondary)">ƒêƒÇNG K√ù T√ÄI KHO·∫¢N</h3>
            <input type="text" id="reg-name" style="width:100%; padding:15px; margin-bottom:15px; border-radius:10px; border:1px solid #ccc; font-size:18px; box-sizing: border-box;" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p">
            <input type="password" id="reg-pass" style="width:100%; padding:15px; margin-bottom:20px; border-radius:10px; border:1px solid #ccc; font-size:18px; box-sizing: border-box;" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
            <button class="btn-sub" style="width:100%; font-size:18px;" onclick="handleRegister()">X√ÅC NH·∫¨N ƒêƒÇNG K√ù</button>
            <p style="margin-top:20px;"><a href="javascript:void(0)" onclick="showLogin()">Quay l·∫°i ƒêƒÉng nh·∫≠p</a></p>
        </div>
    </div>
</div>

<div id="main-app" class="hidden">
    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div id="welcome-msg" style="font-weight:bold; color:var(--secondary); font-size:20px;"></div>
            <button onclick="handleLogout()" style="background:#999; color:white; padding:5px 15px; font-size:14px; box-shadow:none;">ƒêƒÉng xu·∫•t</button>
        </div>

        <nav>
            <button class="btn-main" onclick="startQuiz(10, 'Ng·∫´u nhi√™n 10 c√¢u')">üé≤ THI 10 C√ÇU</button>
            <button class="btn-orange" onclick="startQuiz(20, 'Ng·∫´u nhi√™n 20 c√¢u')">üî• THI 20 C√ÇU</button>
            <button class="btn-sub" onclick="renderSets()">üî¢ THEO B·ªò ƒê·ªÄ</button>
            <button class="btn-purple" onclick="renderLessons()">üìñ THEO B√ÄI H·ªåC</button>
            <button class="btn-green" onclick="renderViewAll()">üìö XEM T·∫§T C·∫¢ ƒê·ªÄ</button>
            <button class="btn-main" style="background:#f39c12; box-shadow: 0 5px #d35400;" onclick="renderHistory()">üìú L·ªäCH S·ª¨</button>
            <button id="admin-btn" class="btn-main hidden" onclick="renderManage()">‚öôÔ∏è QU·∫¢N L√ù</button>
        </nav>

        <div id="top-result" class="result-header">
            <div id="score-text"></div>
            <button class="btn-sub" onclick="location.reload()">L√ÄM ƒê·ªÄ KH√ÅC</button>
        </div>

        <div id="selector-bar" class="hidden" style="background:#f1f1f1; padding:15px; border-radius:15px; margin-bottom:15px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; border:1px solid #ddd;"></div>
        <div id="app-area"></div>
        <button class="btn-main hidden" id="submit-btn" style="width:100%; font-size:24px; padding:20px; border-radius:15px; margin-top:20px" onclick="submitQuiz()">N·ªòP B√ÄI KI·ªÇM TRA</button>
    </div>
</div>

<script>
// --- CONFIG & GLOBAL STATE ---
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcdBNKk1UcnVah-VFoLa5-6QDhGN8ZEIyAtjdCjj53Sy_gfKS5ODe1lZ_TkGBPXw/pub?output=csv'; // D√°n link CSV c·ªßa b·∫°n v√†o ƒë√¢y

let App = {
    users: JSON.parse(localStorage.getItem('k76_v27_users')) || {},
    session: localStorage.getItem('k76_v27_session'),
    db: JSON.parse(localStorage.getItem('k76_v27_db')) || [
        {"bai":"1","q":"M√¥n h·ªçc n√†y l√† g√¨?","a":"VƒÉn ho√° Ph√°t tri·ªÉn","b":"L·ªãch s·ª≠ ƒê·∫£ng","c":"Tri·∫øt h·ªçc","d":"Lu·∫≠t","ans":"A"}
    ],
    currentQs: [],
    type: ''
};

// --- INITIALIZATION ---
window.onload = () => {
    syncOnlineData(); // Ch·∫°y ng·∫ßm, kh√¥ng ƒë·ª£i
    if (App.session) {
        launchApp(App.session);
    }
};

// --- AUTH FUNCTIONS (BULLETPROOF) ---
function showReg() { document.getElementById('login-section').classList.add('hidden'); document.getElementById('reg-section').classList.remove('hidden'); }
function showLogin() { document.getElementById('login-section').classList.remove('hidden'); document.getElementById('reg-section').classList.add('hidden'); }

function handleLogin() {
    const n = document.getElementById('user-name').value.trim();
    const p = document.getElementById('user-pass').value.trim();
    if(!n || !p) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");

    // BYPASS ADMIN
    if(n === 'admin' && p === 'admin') {
        App.users['admin'] = { pass: 'admin', history: App.users['admin']?.history || [] };
        saveAndLaunch('admin');
        return;
    }

    // CHECK USER
    if(App.users[n] && App.users[n].pass === p) {
        saveAndLaunch(n);
    } else {
        alert("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!");
    }
}

function handleGuest() {
    const guestId = "Kh√°ch_" + Math.floor(Math.random()*9999);
    App.users[guestId] = { history: [] };
    saveAndLaunch(guestId);
}

function handleRegister() {
    const n = document.getElementById('reg-name').value.trim();
    const p = document.getElementById('reg-pass').value.trim();
    if(!n || !p) return alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß!");
    if(n.toLowerCase() === 'admin') return alert("Kh√¥ng ƒë∆∞·ª£c d√πng t√™n admin!");
    if(App.users[n]) return alert("T√™n ƒë√£ t·ªìn t·∫°i!");

    App.users[n] = { pass: p, history: [] };
    localStorage.setItem('k76_v27_users', JSON.stringify(App.users));
    alert("ƒêƒÉng k√Ω th√†nh c√¥ng! H√£y ƒëƒÉng nh·∫≠p.");
    showLogin();
}

function saveAndLaunch(name) {
    localStorage.setItem('k76_v27_session', name);
    localStorage.setItem('k76_v27_users', JSON.stringify(App.users));
    launchApp(name);
}

function launchApp(name) {
    App.session = name;
    document.getElementById('auth-page').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
    document.getElementById('welcome-msg').innerText = (name === 'admin' ? "üëë Qu·∫£n tr·ªã: " : "Th√†nh vi√™n: ") + name;
    if(name === 'admin') document.getElementById('admin-btn').classList.remove('hidden');
    startQuiz(10, 'Thi ng·∫´u nhi√™n 10 c√¢u');
}

function handleLogout() { localStorage.removeItem('k76_v27_session'); location.reload(); }

// --- DATA FUNCTIONS ---
async function syncOnlineData() {
    try {
        const response = await fetch(SHEET_URL);
        if (!response.ok) return;
        const csv = await response.text();
        const workbook = XLSX.read(csv, {type:'string'});
        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        
        App.db = json.map(r => {
            const f = (k) => Object.keys(r).find(x => x.trim().toLowerCase() === k.toLowerCase());
            return {
                bai: String(r[f('B√†i')]||'?').trim(),
                q: r[f('C√¢u h·ªèi')], a: r[f('A')], b: r[f('B')], c: r[f('C')], d: r[f('D')],
                ans: (r[f('ƒê√°p √°n')]||'').toString().trim().toUpperCase()
            };
        }).filter(x => x.q);
        
        localStorage.setItem('k76_v27_db', JSON.stringify(App.db));
        console.log("ƒê√£ ƒë·ªìng b·ªô " + App.db.length + " c√¢u h·ªèi.");
    } catch(e) { console.log("Offline mode."); }
}

// --- QUIZ FUNCTIONS ---
function startQuiz(count, type) {
    document.getElementById('top-result').style.display = 'none';
    document.getElementById('selector-bar').classList.add('hidden');
    document.getElementById('app-area').innerHTML = '';
    App.type = type;
    App.currentQs = [...App.db].sort(() => 0.5 - Math.random()).slice(0, count);
    renderQuiz();
}

function renderQuiz() {
    if(App.currentQs.length === 0) return document.getElementById('app-area').innerHTML = "Ch∆∞a c√≥ d·ªØ li·ªáu!";
    document.getElementById('submit-btn').classList.remove('hidden');
    document.getElementById('app-area').innerHTML = App.currentQs.map((q, i) => `
        <div class="q-block" id="wrap-${i}">
            <p>${i+1}. ${q.q} <span style="font-size:14px; color:#999;">(B√†i ${q.bai})</span></p>
            ${['a','b','c','d'].map(opt => `
                <label class="option-item">
                    <input type="radio" name="q${i}" value="${opt.toUpperCase()}">
                    <span>${opt.toUpperCase()}. ${q[opt]}</span>
                </label>
            `).join('')}
        </div>
    `).join('');
}

function submitQuiz() {
    let score = 0;
    App.currentQs.forEach((q, i) => {
        const sel = document.querySelector(`input[name="q${i}"]:checked`);
        const wrap = document.getElementById(`wrap-${i}`);
        if(sel && sel.value === q.ans) score++;
        else { wrap.classList.add('wrong-ans'); wrap.innerHTML += `<b style="color:red; margin-left:52px; font-size:20px;">=> ƒê√ÅP √ÅN ƒê√öNG: ${q.ans}</b>`; }
    });
    
    if(!App.users[App.session].history) App.users[App.session].history = [];
    App.users[App.session].history.push({ date: new Date().toLocaleString(), type: App.type, score: `${score}/${App.currentQs.length}` });
    localStorage.setItem('k76_v27_users', JSON.stringify(App.users));

    document.getElementById('score-text').innerHTML = `<h2>K·∫æT QU·∫¢: ${score} / ${App.currentQs.length} C√ÇU</h2>`;
    document.getElementById('top-result').style.display = 'block';
    document.getElementById('submit-btn').classList.add('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// --- NAV RENDERERS ---
function renderSets() {
    const bar = document.getElementById('selector-bar'); bar.classList.remove('hidden');
    bar.innerHTML = "<b>B·ªô ƒë·ªÅ: </b>";
    for(let i=0; i<Math.ceil(App.db.length/10); i++) {
        let btn = document.createElement('button'); btn.innerText = i+1; btn.className = 'btn-sub';
        btn.onclick = () => { App.type='B·ªô '+(i+1); App.currentQs=App.db.slice(i*10,(i+1)*10); renderQuiz(); };
        bar.appendChild(btn);
    }
}
function renderLessons() {
    const bar = document.getElementById('selector-bar'); bar.classList.remove('hidden');
    const lessons = [...new Set(App.db.map(q => String(q.bai)))].sort((a,b)=>a.localeCompare(b,undefined,{numeric:true}));
    bar.innerHTML = "<b>Ch·ªçn b√†i: </b>";
    lessons.forEach(l => {
        let btn = document.createElement('button'); btn.innerText = "B√†i "+l; btn.className = 'btn-purple';
        btn.onclick = () => { App.type='B√†i '+l; App.currentQs=App.db.filter(q => String(q.bai) === l); renderQuiz(); };
        bar.appendChild(btn);
    });
}
function renderViewAll() {
    document.getElementById('top-result').style.display = 'none';
    document.getElementById('submit-btn').classList.add('hidden');
    document.getElementById('app-area').innerHTML = `<h2 style="text-align:center">T·ªîNG H·ª¢P ƒê·ªÄ V√Ä ƒê√ÅP √ÅN</h2>` + App.db.map((q, i) => `
        <div class="q-block"><p>${i+1}. ${q.q}</p>
        <div style="color:${q.ans==='A'?'green':'#666'}">A. ${q.a}</div><div style="color:${q.ans==='B'?'green':'#666'}">B. ${q.b}</div>
        <div style="color:${q.ans==='C'?'green':'#666'}">C. ${q.c}</div><div style="color:${q.ans==='D'?'green':'#666'}">D. ${q.d}</div></div>`).join('');
}
function renderHistory() {
    const hist = App.users[App.session]?.history || [];
    document.getElementById('app-area').innerHTML = `<div class="table-area"><table><tr><th>Th·ªùi gian</th><th>Lo·∫°i ƒë·ªÅ</th><th>K·∫øt qu·∫£</th></tr>${hist.slice().reverse().map(h => `<tr><td>${h.date}</td><td>${h.type}</td><td style="color:green; font-weight:bold">${h.score}</td></tr>`).join('')}</table></div>`;
}
function renderManage() {
    document.getElementById('app-area').innerHTML = `<div style="text-align:center; padding:30px;"><h3>D·ªÆ LI·ªÜU GOOGLE SHEETS</h3><p>H√£y ch·ªânh s·ª≠a c√¢u h·ªèi tr·ª±c ti·∫øp tr√™n file Google Sheets.</p><div class="table-area"><table><tr><th>STT</th><th>B√†i</th><th>C√¢u h·ªèi</th><th>ƒêA</th></tr>${App.db.map((q,i)=>`<tr><td>${i+1}</td><td>${q.bai}</td><td>${q.q}</td><td>${q.ans}</td></tr>`).join('')}</table></div></div>`;
}
</script>
</body>
</html>
