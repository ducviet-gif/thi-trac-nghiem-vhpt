<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>K76.A03 - H·ªá th·ªëng √în thi VHPT v23</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary: #2c3e50; --secondary: #27ae60; --danger: #e74c3c; 
            --accent: #2980b9; --light: #f4f7f6; --shadow: 0 12px 40px rgba(0,0,0,0.4);
        }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; color: #1a1a1a; font-size: 20px; background-color: var(--light); }
        
        /* Auth Page */
        #auth-page { 
            height: 100vh; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?auto=format&fit=crop&w=1920&q=80');
            background-size: cover; background-position: center; position: fixed; width: 100%; z-index: 999;
        }
        .auth-box { background: white; padding: 40px; border-radius: 25px; width: 450px; box-shadow: var(--shadow); text-align: center; }
        
        /* Main UI */
        .container { max-width: 1250px; margin: 20px auto; background: white; padding: 30px; border-radius: 25px; box-shadow: var(--shadow); }
        nav { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        
        button { padding: 12px 20px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 17px; transition: 0.1s; box-shadow: 0 5px #7f8c8d; position: relative; }
        button:active { box-shadow: 0 0 #7f8c8d; transform: translateY(5px); }
        .btn-main { background: var(--primary); color: white; }
        .btn-sub { background: var(--accent); color: white; box-shadow: 0 5px #1a5276; }
        .btn-green { background: var(--secondary); color: white; box-shadow: 0 5px #196f3d; }
        .btn-orange { background: #d35400; color: white; box-shadow: 0 5px #a04000; }
        .btn-purple { background: #8e44ad; color: white; box-shadow: 0 5px #6c3483; }
        .btn-danger { background: var(--danger); color: white; box-shadow: 0 5px #922b21; }

        /* Question Blocks */
        .q-block { border: 1px solid #cfd8dc; padding: 25px; margin: 15px 0; border-radius: 15px; background: #fff; border-left: 8px solid var(--accent); }
        .q-block p { font-weight: bold; font-size: 24px; color: #0d47a1; margin-top: 0; line-height: 1.4; }
        .option-item { display: flex; align-items: center; margin: 12px 0; padding: 15px; border-radius: 12px; border: 1px solid #eee; cursor: pointer; }
        .option-item:hover { background: #f0f7ff; }
        input[type="radio"] { width: 35px; height: 35px; margin-right: 20px; flex-shrink: 0; cursor: pointer; }
        
        .correct-ans { background: #e8f5e9 !important; border-left: 12px solid #2e7d32 !important; }
        .wrong-ans { background: #ffebee !important; border-left: 12px solid #c62828 !important; }
        
        .table-area { max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #eceff1; padding: 15px; position: sticky; top: 0; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .hidden { display: none !important; }
        .selector-bar { background: #f1f1f1; padding: 15px; border-radius: 15px; margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div id="auth-page">
    <div class="auth-box">
        <h1 style="color:var(--primary); font-size: 26px; margin-bottom: 5px;">H·ªá th·ªëng tr·∫Øc nghi·ªám VHPT</h1>
        <h2 style="color:var(--accent); font-size: 22px; margin-bottom: 25px;">L·ªõp: K76.A03</h2>
        <div id="login-form">
            <input type="text" id="user-name" style="width:100%; padding:15px; margin-bottom:15px; border-radius:10px; border:1px solid #ccc; font-size:18px;" placeholder="T√™n t√†i kho·∫£n">
            <input type="password" id="user-pass" style="width:100%; padding:15px; margin-bottom:20px; border-radius:10px; border:1px solid #ccc; font-size:18px;" placeholder="M·∫≠t kh·∫©u">
            <button class="btn-main" style="width:100%" onclick="login()">ƒêƒÇNG NH·∫¨P</button>
            <button class="btn-green" style="width:100%; margin-top:10px;" onclick="loginGuest()">V√ÄO NHANH (KH√ÅCH)</button>
            <p>Ch∆∞a c√≥ t√†i kho·∫£n? <a href="javascript:void(0)" onclick="toggleAuth(false)">ƒêƒÉng k√Ω ngay</a></p>
        </div>
        <div id="register-form" class="hidden">
            <input type="text" id="reg-name" style="width:100%; padding:15px; margin-bottom:15px; border-radius:10px; border:1px solid #ccc; font-size:18px;" placeholder="T√™n t√†i kho·∫£n m·ªõi">
            <input type="password" id="reg-pass" style="width:100%; padding:15px; margin-bottom:20px; border-radius:10px; border:1px solid #ccc; font-size:18px;" placeholder="M·∫≠t kh·∫©u">
            <button class="btn-sub" style="width:100%" onclick="register()">X√ÅC NH·∫¨N ƒêƒÇNG K√ù</button>
            <p><a href="javascript:void(0)" onclick="toggleAuth(true)">Quay l·∫°i ƒêƒÉng nh·∫≠p</a></p>
        </div>
    </div>
</div>

<div id="app-content" class="hidden">
    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div id="welcome" style="font-weight:bold; color:var(--secondary);"></div>
            <button onclick="logout()" style="background:#999; color:white; padding:5px 15px; font-size:14px; box-shadow:none;">ƒêƒÉng xu·∫•t</button>
        </div>

        <nav>
            <button class="btn-main" onclick="startQuiz(10, 'Ng·∫´u nhi√™n 10 c√¢u')">üé≤ THI 10 C√ÇU</button>
            <button class="btn-orange" onclick="startQuiz(20, 'Ng·∫´u nhi√™n 20 c√¢u')">üî• THI 20 C√ÇU</button>
            <button class="btn-sub" onclick="showSequentialBar()">üî¢ THEO B·ªò ƒê·ªÄ</button>
            <button class="btn-purple" onclick="showLessonBar()">üìñ THEO B√ÄI H·ªåC</button>
            <button class="btn-green" onclick="viewAll()">üìö XEM T·∫§T C·∫¢</button>
            <button class="btn-main" style="background:#f39c12" onclick="showHistory()">üìú L·ªäCH S·ª¨</button>
            <button class="btn-main" onclick="showManage()">‚öôÔ∏è QU·∫¢N L√ù</button>
        </nav>

        <div id="top-result" style="display:none; background:#fff9c4; border:4px solid #fbc02d; padding:20px; border-radius:15px; text-align:center; margin-bottom:20px;">
            <div id="result-text"></div>
            <button class="btn-sub" onclick="location.reload()">L√ÄM ƒê·ªÄ KH√ÅC</button>
        </div>

        <div id="selector-bar" class="hidden selector-bar"></div>
        <div id="main-area"></div>
        <button class="btn-main hidden" id="submit-btn" style="width:100%; font-size:24px; padding:20px; margin-top:20px" onclick="submitQuiz()">N·ªòP B√ÄI KI·ªÇM TRA</button>
    </div>
</div>

<script>
// --- STATE & DATA ---
let App = {
    users: JSON.parse(localStorage.getItem('k76_v23_users')) || {},
    session: localStorage.getItem('k76_v23_session'),
    db: JSON.parse(localStorage.getItem('k76_v23_db')) || [
        {"bai":"1","q":"Quan ni·ªám v·ªÅ vƒÉn h√≥a c·ªßa H·ªì Ch√≠ Minh ƒë∆∞a ra nƒÉm n√†o?","a":"1930","b":"1943","c":"1958","d":"1950","ans":"B"},
        {"bai":"2","q":"Ng√†y qu·ªëc t·∫ø v·ªÅ quy·ªÅn con ng∆∞·ªùi l√† ng√†y n√†o?","a":"12/10","b":"2/9","c":"15/8","d":"10/12","ans":"D"}
    ],
    currentQs: [],
    type: ''
};

window.onload = () => { if(App.session) loginSuccess(App.session); };

// --- AUTHENTICATION ---
function toggleAuth(isLogin) {
    document.getElementById('login-form').classList.toggle('hidden', !isLogin);
    document.getElementById('register-form').classList.toggle('hidden', isLogin);
}
function register() {
    const n = document.getElementById('reg-name').value.trim();
    const p = document.getElementById('reg-pass').value.trim();
    if(!n || !p) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin!");
    App.users[n] = { pass: p, history: [] };
    localStorage.setItem('k76_v23_users', JSON.stringify(App.users));
    alert("ƒêƒÉng k√Ω xong! H√£y ƒëƒÉng nh·∫≠p."); toggleAuth(true);
}
function login() {
    const n = document.getElementById('user-name').value.trim();
    const p = document.getElementById('user-pass').value.trim();
    if(App.users[n] && App.users[n].pass === p) {
        localStorage.setItem('k76_v23_session', n);
        loginSuccess(n);
    } else alert("Sai th√¥ng tin!");
}
function loginGuest() {
    const id = "Kh√°ch_" + Math.floor(Math.random()*999);
    if(!App.users[id]) App.users[id] = { history: [] };
    localStorage.setItem('k76_v23_session', id);
    loginSuccess(id);
}
function loginSuccess(name) {
    App.session = name;
    document.getElementById('auth-page').classList.add('hidden');
    document.getElementById('app-content').classList.remove('hidden');
    document.getElementById('welcome').innerText = "Th√†nh vi√™n: " + name;
    startQuiz(10, 'Thi ng·∫´u nhi√™n 10 c√¢u');
}
function logout() { localStorage.removeItem('k76_v23_session'); location.reload(); }

// --- QUIZ FUNCTIONS ---
function startQuiz(count, type) {
    document.getElementById('top-result').style.display = 'none';
    document.getElementById('selector-bar').classList.add('hidden');
    document.getElementById('main-area').innerHTML = '';
    App.type = type;
    App.currentQs = [...App.db].sort(() => 0.5 - Math.random()).slice(0, count);
    renderQuiz();
}

function renderQuiz() {
    if(App.currentQs.length === 0) return document.getElementById('main-area').innerHTML = "<h3 style='text-align:center'>Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi ph√π h·ª£p!</h3>";
    document.getElementById('submit-btn').classList.remove('hidden');
    document.getElementById('main-area').innerHTML = App.currentQs.map((q, i) => `
        <div class="q-block" id="wrap-${i}">
            <p>${i+1}. ${q.q}</p>
            ${['a','b','c','d'].map(opt => `
                <label class="option-item">
                    <input type="radio" name="q${i}" value="${opt.toUpperCase()}">
                    <span>${opt.toUpperCase()}. ${q[opt]}</span>
                </label>
            `).join('')}
        </div>
    `).join('');
}

function submitQuiz() {
    let score = 0;
    App.currentQs.forEach((q, i) => {
        const sel = document.querySelector(`input[name="q${i}"]:checked`);
        const wrap = document.getElementById(`wrap-${i}`);
        if(sel && sel.value === q.ans) score++;
        else { wrap.classList.add('wrong-ans'); wrap.innerHTML += `<b style="color:red; margin-left:55px; font-size:20px;">=> ƒê√ÅP √ÅN ƒê√öNG: ${q.ans}</b>`; }
    });
    
    if(!App.users[App.session].history) App.users[App.session].history = [];
    App.users[App.session].history.push({ date: new Date().toLocaleString(), type: App.type, score: `${score}/${App.currentQs.length}` });
    localStorage.setItem('k76_v23_users', JSON.stringify(App.users));
    
    document.getElementById('result-text').innerHTML = `<h2>K·∫æT QU·∫¢ THI: ${score} / ${App.currentQs.length}</h2>`;
    document.getElementById('top-result').style.display = 'block';
    document.getElementById('submit-btn').classList.add('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// --- SELECTOR BARS (FIXED LOGIC) ---
function showSequentialBar() {
    const bar = document.getElementById('selector-bar'); bar.classList.remove('hidden');
    document.getElementById('main-area').innerHTML = '';
    let totalSets = Math.ceil(App.db.length/10);
    bar.innerHTML = "<b>Ch·ªçn b·ªô ƒë·ªÅ: </b>";
    for(let i=0; i<totalSets; i++) {
        let btn = document.createElement('button');
        btn.innerText = i+1;
        btn.className = 'btn-sub';
        btn.onclick = () => {
            App.type = 'B·ªô ƒë·ªÅ ' + (i+1);
            App.currentQs = App.db.slice(i*10, (i+1)*10);
            renderQuiz();
        };
        bar.appendChild(btn);
    }
}

function showLessonBar() {
    const bar = document.getElementById('selector-bar'); bar.classList.remove('hidden');
    document.getElementById('main-area').innerHTML = '';
    // L·∫•y danh s√°ch b√†i duy nh·∫•t v√† s·∫Øp x·∫øp
    const lessons = [...new Set(App.db.map(q => String(q.bai).trim()))].sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));
    bar.innerHTML = "<b>Ch·ªçn b√†i h·ªçc: </b>";
    lessons.forEach(l => {
        let btn = document.createElement('button');
        btn.innerText = "B√†i " + l;
        btn.className = 'btn-purple';
        btn.style.margin = '2px';
        btn.onclick = () => {
            App.type = 'B√†i h·ªçc ' + l;
            // Chuy·ªÉn c·∫£ hai v·ªÅ chu·ªói ƒë·ªÉ so s√°nh ch√≠nh x√°c 100%
            App.currentQs = App.db.filter(q => String(q.bai).trim() === String(l));
            renderQuiz();
        };
        bar.appendChild(btn);
    });
}

// --- EXCEL & DATA MANAGEMENT ---
function importExcel() {
    const file = document.getElementById('excel-file').files[0];
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            App.db = json.map(row => {
                const f = (k) => Object.keys(row).find(x => x.trim().toLowerCase() === k.toLowerCase());
                return {
                    bai: String(row[f('B√†i')] || '?').trim(), 
                    q: row[f('C√¢u h·ªèi')],
                    a: row[f('A')], b: row[f('B')], c: row[f('C')], d: row[f('D')],
                    ans: (row[f('ƒê√°p √°n')] || '').toString().trim().toUpperCase()
                };
            }).filter(x => x.q);
            localStorage.setItem('k76_v23_db', JSON.stringify(App.db));
            alert("N·∫°p th√†nh c√¥ng " + App.db.length + " c√¢u!");
            showManage();
        } catch(err) { alert("L·ªói ƒë·ªçc file Excel!"); }
    };
    reader.readAsArrayBuffer(file);
}

function downloadSample() {
    const data = [["B√†i", "C√¢u h·ªèi", "A", "B", "C", "D", "ƒê√°p √°n"], ["1", "C√¢u m·∫´u?", "A", "B", "C", "D", "A"]];
    XLSX.writeFile(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.aoa_to_sheet(data), "Mau"), "Mau_K76A03.xlsx");
}

function showManage() {
    document.getElementById('selector-bar').classList.add('hidden');
    document.getElementById('submit-btn').classList.add('hidden');
    let html = `
        <div style="background:#eef2f3; padding:20px; border-radius:15px; margin-bottom:20px">
            <input type="file" id="excel-file" accept=".xlsx, .xls, .csv">
            <button class="btn-sub" onclick="importExcel()">N·∫†P D·ªÆ LI·ªÜU</button>
            <button class="btn-main" onclick="downloadSample()">T·∫¢I M·∫™U</button>
            <button class="btn-danger" onclick="if(confirm('X√≥a s·∫°ch?')){App.db=[];localStorage.removeItem('k76_v23_db');showManage();}">X√ìA KHO</button>
        </div>
        <div class="table-area">
            <table>
                <tr><th>STT</th><th>B√†i</th><th>C√¢u h·ªèi & L·ª±a ch·ªçn</th><th>ƒêA</th></tr>
                ${App.db.map((q, i) => `<tr><td style="text-align:center">${i+1}</td><td style="text-align:center">${q.bai}</td><td><b>${q.q}</b><br><small>A: ${q.a} | B: ${q.b} | C: ${q.c} | D: ${q.d}</small></td><td style="color:red; font-weight:bold; text-align:center">${q.ans}</td></tr>`).join('')}
            </table>
        </div>`;
    document.getElementById('main-area').innerHTML = html;
}

function viewAll() {
    document.getElementById('submit-btn').classList.add('hidden');
    document.getElementById('selector-bar').classList.add('hidden');
    document.getElementById('main-area').innerHTML = `<h2 style="text-align:center">TO√ÄN B·ªò ƒê·ªÄ V√Ä ƒê√ÅP √ÅN</h2>` + App.db.map((q, i) => `
        <div class="q-block">
            <p>${i+1}. ${q.q} (B√†i: ${q.bai})</p>
            <div style="color:${q.ans==='A'?'green':'#666'}">A. ${q.a}</div>
            <div style="color:${q.ans==='B'?'green':'#666'}">B. ${q.b}</div>
            <div style="color:${q.ans==='C'?'green':'#666'}">C. ${q.c}</div>
            <div style="color:${q.ans==='D'?'green':'#666'}">D. ${q.d}</div>
        </div>`).join('');
}

function showHistory() {
    const hist = App.users[App.session].history || [];
    document.getElementById('main-area').innerHTML = `<div class="table-area"><table><tr><th>Th·ªùi gian</th><th>Lo·∫°i ƒë·ªÅ</th><th>K·∫øt qu·∫£</th></tr>${hist.slice().reverse().map(h => `<tr><td>${h.date}</td><td>${h.type}</td><td style="color:green; font-weight:bold">${h.score}</td></tr>`).join('')}</table></div>`;
}
</script>
</body>
</html>
